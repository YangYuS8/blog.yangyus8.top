services:
  blog:
    image: ${BLOG_IMAGE:-ghcr.io/OWNER/hexo-blog:latest}  # CI 构建推送后的镜像（建议在 .env 中配置 BLOG_IMAGE）
    container_name: hexo-blog
    restart: unless-stopped
    ports:
      - "80:80"   # 若由上层反向代理再做 80/443，可改成 "127.0.0.1:8080:80"
    depends_on:
      - waline
    environment:
      WALINE_SERVER_URL: ${WALINE_PUBLIC_URL:-https://blog.example.com/comment/}
    labels:
      # 仅为 blog 服务开启 watchtower 自动更新，其它服务保持不自动更新
      - "com.centurylinklabs.watchtower.enable=true"

  waline-db:
    image: mariadb:11.4
    container_name: waline-db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Shanghai
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - ${WALINE_DB_DIR:-./data/waline-db}:/var/lib/mysql

  waline:
    image: walinejs/server:latest
    container_name: waline
    restart: unless-stopped
    depends_on:
      - waline-db
    env_file:
      - .env
    environment:
      TZ: Asia/Shanghai
      DISABLE_EMAIL: 'true'
      MYSQL_HOST: waline-db
      MYSQL_PORT: 3306
    volumes:
      - ${WALINE_DATA_DIR:-./data/waline}:/data
    expose:
      - "8360"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: 1800   # 每 30 分钟轮询一次
      WATCHTOWER_LABEL_ENABLE: "true"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"



# 生产环境建议用 Caddy / Nginx 在宿主机做 80/443 入口 + 证书管理
