services:
  blog:
    image: ${BLOG_IMAGE:-ghcr.io/OWNER/yangyus8-blog:latest}  # CI 构建推送后的镜像（建议在 .env 中配置 BLOG_IMAGE）
    container_name: yangyus8-blog
    restart: unless-stopped
    ports:
      - "80:80"   # 若由上层反向代理再做 80/443，可改成 "127.0.0.1:8080:80"
    depends_on:
      - twikoo
    environment:
      # 自托管 Twikoo API 地址（供前端主题配置/回显用，可选，主题直接使用 _config.fluid.yml 中的 envId）
      TWIKOO_API_URL: ${TWIKOO_PUBLIC_URL:-https://blog.yangyus8.top/twikoo/}
    labels:
      # 仅为 blog 服务开启 watchtower 自动更新，其它服务保持不自动更新
      - "com.centurylinklabs.watchtower.enable=true"

  # --- Twikoo 评论系统（自托管模式） ---
  # 数据库：MongoDB（Twikoo 原生使用 Mongo）
  twikoo-db:
    image: mongo:7.0
    container_name: twikoo-db
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
    command: >-
      mongod --bind_ip 0.0.0.0 --replSet rs0 --oplogSize 128
    volumes:
      - ${TWIKOO_DB_DIR:-./data/twikoo-db}:/data/db
    # 初始化副本集（只需一次）可在容器启动后执行：docker exec -it twikoo-db mongosh --eval 'rs.initiate()'
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # 副本集自动初始化（一次性 Job）
  twikoo-rs-init:
    image: mongo:7.0
    depends_on:
      - twikoo-db
    entrypoint: ["/bin/bash","-c"]
    command: |
      set -e
      echo '[twikoo-rs-init] waiting mongo'
      for i in $(seq 1 30); do
        if mongosh --host twikoo-db:27017 --quiet --eval 'db.adminCommand("ping").ok' >/dev/null 2>&1; then echo 'mongo up'; break; fi; sleep 2; done
      mongosh --host twikoo-db:27017 --quiet --eval 'try { rs.status() } catch(e) { rs.initiate({_id:"rs0", members:[{_id:0, host:"twikoo-db:27017"}]}); }'
      mongosh --host twikoo-db:27017 --quiet --eval 'rs.status().members.forEach(m=>print("member:", m.name, m.stateStr))'
      echo '[twikoo-rs-init] done.'
    restart: "no"

  # 索引自动创建（可重复执行，幂等）
  twikoo-index-init:
    image: mongo:7.0
    depends_on:
      - twikoo-rs-init
    entrypoint: ["/bin/bash","-c"]
    command: |
      set -e
      echo '[twikoo-index-init] ensuring indexes'
      mongosh --host twikoo-db:27017 twikoo --quiet --eval '
        function ei(c, spec, opt){
          const names=db.getCollection(c).getIndexes().map(i=>i.name);
          if(!names.includes(opt.name)){ db.getCollection(c).createIndex(spec, opt); print("created:"+opt.name); } else { print("exists:"+opt.name); }
        }
        ei("comment", { url:1 }, { name:"url_1" });
        ei("comment", { created:-1 }, { name:"created_-1" });
        ei("comment", { rid:1 }, { name:"rid_1" });
        ei("comment", { mailMd5:1 }, { name:"mailMd5_1" });
        ei("counter", { url:1 }, { name:"url_counter_1" });
        print("[twikoo-index-init] complete");
      '
    restart: "no"

  twikoo:
    image: imaegoo/twikoo:latest
    container_name: twikoo
    restart: unless-stopped
    depends_on:
      twikoo-index-init:
        condition: service_completed_successfully
    environment:
      TZ: Asia/Shanghai
      # 如果副本集已初始化，使用 mongodb://twikoo-db:27017/twikoo?replicaSet=rs0
      MONGO_URL: ${TWIKOO_MONGO_URL:-mongodb://twikoo-db:27017/twikoo?replicaSet=rs0}
      # 允许的 CORS 来源（逗号分隔多个域名），可在 .env 中覆盖
      TWIKOO_CORS_ALLOW_ORIGIN: ${TWIKOO_CORS_ALLOW_ORIGIN:-https://blog.yangyus8.top}
      # 节流 & 其他可选：TWIKOO_THROTTLE, TWIKOO_MAX_COMMENT_NEST, etc.
    expose:
      - "8080"
    # 若需要持久化上传文件（Twikoo 支持对象存储适配，可后续拓展）
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: 1800   # 每 30 分钟轮询一次
      WATCHTOWER_LABEL_ENABLE: "true"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: minio
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Shanghai
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001" # 控制台 (可由上层反代保护)
    volumes:
      - ${MINIO_DATA_DIR:-./data/minio}:/data

# 生产环境建议用 Caddy / Nginx 在宿主机做 80/443 入口 + 证书管理
