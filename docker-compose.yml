services:
  blog:
    image: ${BLOG_IMAGE:-ghcr.io/OWNER/yangyus8-blog:latest}  # CI 构建推送后的镜像（建议在 .env 中配置 BLOG_IMAGE）
    container_name: yangyus8-blog
    restart: unless-stopped
    ports:
      - "80:80"   # 若由上层反向代理再做 80/443，可改成 "127.0.0.1:8080:80"
    depends_on:
      - waline
    environment:
      WALINE_SERVER_URL: ${WALINE_PUBLIC_URL:-https://blog.yangyus8.top/comment/}
    labels:
      # 仅为 blog 服务开启 watchtower 自动更新，其它服务保持不自动更新
      - "com.centurylinklabs.watchtower.enable=true"

  waline-db:
    image: mariadb:11.4
    container_name: waline-db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Shanghai
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - ${WALINE_DB_DIR:-./data/waline-db}:/var/lib/mysql

  waline:
    image: lizheming/waline:latest
    container_name: waline
    restart: unless-stopped
    depends_on:
      - waline-db
    env_file:
      - .env
    environment:
      TZ: Asia/Shanghai
      DISABLE_EMAIL: 'true'
      MYSQL_HOST: waline-db
      MYSQL_PORT: 3306
    volumes:
      - ${WALINE_DATA_DIR:-./data/waline}:/data
    expose:
      - "8360"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: 1800   # 每 30 分钟轮询一次
      WATCHTOWER_LABEL_ENABLE: "true"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    restart: unless-stopped
    env_file:
      - .env
    environment:
      TZ: Asia/Shanghai
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001" # 控制台 (可由上层反代保护)
    volumes:
      - ${MINIO_DATA_DIR:-./data/minio}:/data

# 生产环境建议用 Caddy / Nginx 在宿主机做 80/443 入口 + 证书管理
